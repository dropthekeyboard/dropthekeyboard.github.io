# MessageBubble Markdown 지원 리팩토링 계획

## 작업의 목적

DemoView에서 사용되는 MessageBubble과 VoiceBubble 컴포넌트에 Markdown 렌더링 기능을 추가하여 AI Agent의 구조화된 응답을 더 효과적으로 표시할 수 있도록 개선합니다. 특히 scenarios.json에 정의된 AI Agent의 복합적인 정보(와인 추천, 예약 안내, 링크 등)를 사용자 친화적인 형태로 렌더링하는 것이 목표입니다.

## 현재의 상태 / 문제점

### 1. 단순 텍스트 렌더링 한계

- **현재 코드**: MessageBubble에서 `{message}` 단순 텍스트 출력
- **문제점**: AI Agent 응답의 구조화된 정보가 평면적으로 표시됨
- **예시**: "해산물 파스타와 잘 어울려요, 산뜻한 피노 그리지오 (아마존 링크)\n고르곤졸라 피자에 추천해요..." → 가독성 부족

### 2. scenarios.json 메시지 형식의 비구조화

- **현재**: 일반 텍스트로 모든 정보가 연결되어 있음
- **문제점**:
  - 중요 정보 하이라이트 불가
  - 링크 클릭 불가 (아마존 링크 등)
  - 목록 형태 정보의 시각적 구분 어려움
  - 구분선(==========) 등의 원시적 구분법 사용

### 3. 컴포넌트 확장성 부족

- MessageBubble과 VoiceBubble 모두 동일한 문제 보유
- 향후 더 복잡한 AI 응답 형식에 대응 어려움
- 테마별 Markdown 스타일링 시스템 부재

### 4. 타입 안전성 이슈

- Markdown 콘텐츠와 일반 텍스트 구분 불가
- 렌더링 모드에 대한 명시적 타입 정의 부재

## 추가 분석 과제

### 1. Markdown 라이브러리 선택 및 성능 분석

- react-markdown vs 대안 라이브러리 성능 비교
- 번들 크기 영향도 측정
- 렌더링 성능 (특히 긴 메시지에서의 반응성)

### 2. 보안 고려사항

- XSS 공격 방지를 위한 HTML sanitization 필요성 검토
- 외부 링크 처리 방식 (새 창 열기, rel="noopener" 등)
- 사용자 입력 Markdown의 제한 범위 설정

### 3. 테마 통합 방안

- shadcn/ui 기본 스타일과 Markdown 요소의 조화
- 다크/라이트 테마에서의 Markdown 가독성
- 커스텀 Markdown 컴포넌트 스타일링 방법론

### 4. 반응형 대응

- 모바일 환경에서의 Markdown 표시 최적화
- 긴 링크나 코드 블록의 반응형 처리

## 변경 이후의 상태 / 해결 판정 기준

### 성공 기준

1. **구조화된 표시**: AI Agent 응답이 Markdown으로 렌더링되어 가독성 향상
2. **인터랙티브 요소**: 링크 클릭 가능, 목록 형태의 명확한 시각적 구분
3. **테마 일관성**: 기존 shadcn/ui 테마와 조화로운 Markdown 스타일링
4. **타입 안전성**: TypeScript 컴파일 에러 없이 모든 props 검증
5. **성능 유지**: Markdown 렌더링으로 인한 성능 저하 없음 (60fps 유지)
6. **재사용성**: MessageBubble과 VoiceBubble 모두에서 동일한 방식으로 Markdown 지원

### 테스트 시나리오

- **시나리오 1**: 와인 추천 목록이 구조화된 형태로 표시
- **시나리오 2**: 아마존 링크가 클릭 가능한 링크로 렌더링
- **시나리오 3**: 다크/라이트 테마 전환 시 Markdown 요소들의 적절한 색상 변경
- **시나리오 4**: 긴 AI 응답에서도 스크롤 성능 유지
- **시나리오 5**: 모바일 환경에서의 적절한 반응형 표시

## 수정이 필요한 코드 및 수정부분

### 1. 패키지 의존성 추가

**파일**: `package.json`

```json
{
  "dependencies": {
    "react-markdown": "^9.0.1",
    "remark-gfm": "^4.0.0"
  }
}
```

### 2. MessageBubble 컴포넌트 개선

**파일**: `/src/components/shared/MessageBubble/index.tsx`

```tsx
// 기존 코드
<motion.span
  initial={{ opacity: 0 }}
  animate={{ opacity: 1 }}
  transition={{ delay: 0.1, duration: 0.2 }}
  className={cn(
    'text-sm leading-relaxed',
    isOwnMessage ? 'text-right' : 'text-left'
  )}
>
  {message}
</motion.span>

// 수정 후 코드
<motion.div
  initial={{ opacity: 0 }}
  animate={{ opacity: 1 }}
  transition={{ delay: 0.1, duration: 0.2 }}
  className={cn(
    'text-sm leading-relaxed prose prose-sm max-w-none',
    'prose-headings:text-foreground prose-p:text-foreground',
    'prose-strong:text-foreground prose-links:text-primary',
    'prose-ul:text-foreground prose-ol:text-foreground',
    isOwnMessage ? 'text-right' : 'text-left'
  )}
>
  <ReactMarkdown
    remarkPlugins={[remarkGfm]}
    components={{
      a: ({ href, children }) => (
        <a
          href={href}
          target="_blank"
          rel="noopener noreferrer"
          className="text-primary hover:text-primary/80 underline"
        >
          {children}
        </a>
      ),
      hr: () => <hr className="border-border my-2" />
    }}
  >
    {message}
  </ReactMarkdown>
</motion.div>
```

### 3. VoiceBubble 컴포넌트 개선

**파일**: `/src/components/shared/VoiceBubble/index.tsx`

```tsx
// 메시지 콘텐츠 부분 수정
<div
  className={cn(
    'text-base leading-relaxed font-medium relative z-10 prose prose-sm max-w-none',
    'prose-headings:text-foreground prose-p:text-foreground',
    'prose-strong:text-foreground prose-links:text-primary',
    currentStyle.text,
    isOwnMessage ? 'text-right' : 'text-left'
  )}
>
  <ReactMarkdown remarkPlugins={[remarkGfm]}>{message}</ReactMarkdown>
</div>
```

### 4. scenarios.json 메시지 형식 개선

**파일**: `/src/data/scenarios.json`

```json
{
  "type": "send-message",
  "action": {
    "from": "customer_agent",
    "to": "customer",
    "content": "네, 캘린더에 등록해드렸어요. 캘린더에 등록된 연락처로 다른 멤버들에게도 문자 알림 드리겠습니다. 와인 모임을 위해 메뉴와 잘 어울릴만한 와인들도 추가 준비해보시는 건 어떤가요?\n\n---\n\n## 🍷 추천 와인 목록\n\n- **피노 그리지오** - 해산물 파스타와 잘 어울려요 ([아마존 링크](https://amazon.com))\n- **모스카토 다스티** - 고르곤졸라 피자에 추천해요 ([아마존 링크](https://amazon.com))\n- **바롤로** - 양고기 로스트와 먹었을 때 평이 좋아요 ([아마존 링크](https://amazon.com))",
    "type": "text"
  }
}
```

### 5. 타입 정의 추가

**파일**: `/src/types/message.ts` (신규 생성)

```typescript
export interface MessageContent {
  text: string;
  format?: 'plain' | 'markdown';
}

export interface MessageBubbleProps {
  message: string;
  isOwnMessage: boolean;
  senderType?: 'user' | 'ai' | 'agent' | 'server-human';
  isTyping?: boolean;
  timestamp?: number;
  isRead?: boolean;
  enableMarkdown?: boolean; // 새로운 옵션
}
```

## 재사용 가능한 연관 코드

### 기존 활용 가능한 구조

- **shadcn/ui 테마 시스템**: `/src/index.css`의 CSS 변수 활용
- **Tailwind Typography**: prose 클래스 기반 Markdown 스타일링
- **Avatar 시스템**: `/src/components/shared/Avatar/avatarHelpers.ts`
- **테마 훅**: `/src/hooks/useTheme.ts`

### 새로운 공통 컴포넌트

**파일**: `/src/components/shared/MarkdownRenderer/index.tsx`

```typescript
interface MarkdownRendererProps {
  content: string;
  className?: string;
  theme?: 'light' | 'dark';
}

export function MarkdownRenderer({
  content,
  className,
  theme,
}: MarkdownRendererProps) {
  // 공통 Markdown 렌더링 로직
}
```

## Test Code 추가 및 수정 필요 부분에 대한 가이드

### 1. 단위 테스트

**파일**: `/src/components/shared/MessageBubble/__tests__/MessageBubble.test.tsx`

```typescript
describe('MessageBubble Markdown Support', () => {
  test('renders plain text correctly', () => {
    // 일반 텍스트 렌더링 테스트
  });

  test('renders markdown links as clickable elements', () => {
    // 링크 렌더링 및 클릭 가능성 테스트
  });

  test('applies proper styling in dark/light themes', () => {
    // 테마별 스타일링 테스트
  });

  test('handles long markdown content without performance issues', () => {
    // 성능 테스트
  });
});
```

### 2. 통합 테스트

- DemoView에서 scenarios.json의 실제 데이터로 Markdown 렌더링 테스트
- 다양한 시나리오에서의 메시지 표시 정확성 검증

### 3. 시각적 회귀 테스트

- Storybook을 활용한 Markdown 렌더링 결과의 시각적 검증
- 다크/라이트 테마에서의 일관성 확인

### 4. 성능 테스트

- 긴 Markdown 콘텐츠에서의 렌더링 시간 측정
- 메모리 사용량 모니터링
- 스크롤 성능 영향도 측정
